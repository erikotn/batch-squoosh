<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BatchSquoosh - Professional Image Optimizer</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- JSZip & FileSaver -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { 
            background-color: #020617; 
            font-family: 'Inter', sans-serif; 
            color: #f8fafc;
            background-image: 
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%), 
                radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
        }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }
        .glass-input:focus {
            border-color: rgba(99, 102, 241, 0.5);
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.3); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.5); }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
        
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-card { animation: fade-in-up 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // --- Icons ---
        const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
        const IconDownload = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
        const IconImage = () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round" className="opacity-20"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>;
        const IconSettings = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>;
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>;
        const IconLoader = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="spinner"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>;
        const IconZap = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>;

        const formatBytes = (bytes, decimals = 2) => {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(decimals)) + ' ' + sizes[i];
        };

        const App = () => {
            const [files, setFiles] = useState([]);
            const [isDragging, setIsDragging] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false);
            const [globalSettings, setGlobalSettings] = useState({
                quality: 0.8,
                format: 'image/jpeg',
                maxWidth: 1920,
            });

            // --- Logic (Identical to previous version) ---
            const compressImage = async (file, settings) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            if (width > settings.maxWidth) {
                                height = Math.round((height * settings.maxWidth) / width);
                                width = settings.maxWidth;
                            }
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            canvas.toBlob((blob) => {
                                if (!blob) { reject(new Error('Failed')); return; }
                                resolve({
                                    original: file,
                                    compressed: blob,
                                    previewUrl: URL.createObjectURL(blob),
                                    originalSize: file.size,
                                    compressedSize: blob.size,
                                    width,
                                    height,
                                    id: Math.random().toString(36).substr(2, 9),
                                    status: 'done'
                                });
                            }, settings.format, settings.quality);
                        };
                        img.onerror = (err) => reject(err);
                    };
                    reader.onerror = (err) => reject(err);
                });
            };

            const handleDrop = useCallback(async (e) => {
                e.preventDefault();
                setIsDragging(false);
                const droppedFiles = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                if (droppedFiles.length === 0) return;
                addFiles(droppedFiles);
            }, [globalSettings]);

            const handleFileSelect = (e) => {
                const selectedFiles = Array.from(e.target.files);
                if (selectedFiles.length === 0) return;
                addFiles(selectedFiles);
            };

            const addFiles = async (newFiles) => {
                setIsProcessing(true);
                const placeholders = newFiles.map(f => ({
                    id: Math.random().toString(36).substr(2, 9),
                    original: f,
                    status: 'processing',
                    originalSize: f.size
                }));
                setFiles(prev => [...prev, ...placeholders]);

                const processedResults = [];
                for (let file of newFiles) {
                    try {
                        const result = await compressImage(file, globalSettings);
                        processedResults.push(result);
                    } catch (error) { console.error(error); }
                }

                setFiles(prev => {
                    const updated = [...prev];
                    processedResults.forEach(res => {
                        const idx = updated.findIndex(f => f.original.name === res.original.name && f.status === 'processing');
                        if (idx !== -1) updated[idx] = res;
                    });
                    return updated;
                });
                setIsProcessing(false);
            };

            useEffect(() => {
                const timeoutId = setTimeout(async () => {
                    if (files.length === 0) return;
                    setIsProcessing(true);
                    const newFiles = await Promise.all(files.map(async (f) => {
                        return await compressImage(f.original, globalSettings);
                    }));
                    setFiles(newFiles);
                    setIsProcessing(false);
                }, 500);
                return () => clearTimeout(timeoutId);
            }, [globalSettings.quality, globalSettings.format, globalSettings.maxWidth]);

            const removeFile = (id) => setFiles(files.filter(f => f.id !== id));

            const downloadAll = async () => {
                const zip = new JSZip();
                const folder = zip.folder("optimized_images");
                files.forEach(f => {
                    let ext = globalSettings.format.split('/')[1];
                    if (ext === 'jpeg') ext = 'jpg';
                    const nameParts = f.original.name.split('.');
                    nameParts.pop();
                    const newName = `${nameParts.join('.')}_min.${ext}`;
                    folder.file(newName, f.compressed);
                });
                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, "batch_optimized_images.zip");
            };

            const totalOriginal = files.reduce((acc, f) => acc + (f.originalSize || 0), 0);
            const totalCompressed = files.reduce((acc, f) => acc + (f.compressedSize || 0), 0);
            const totalSavings = totalOriginal > 0 ? ((totalOriginal - totalCompressed) / totalOriginal * 100).toFixed(1) : 0;

            return (
                <div className="min-h-screen flex flex-col items-center py-12 px-4 md:px-8">
                    
                    {/* --- Header --- */}
                    <div className="text-center mb-10 animate-card">
                        <div className="inline-flex items-center gap-2 mb-3 px-4 py-1.5 rounded-full bg-indigo-500/10 border border-indigo-500/20 text-indigo-300 text-xs font-medium tracking-wide">
                            <IconZap /> 100% Client-Side Processing
                        </div>
                        <h1 className="text-5xl font-bold tracking-tight text-white mb-3 drop-shadow-lg">
                            Batch<span className="text-indigo-400">Squoosh</span>
                        </h1>
                        <p className="text-slate-400 max-w-lg mx-auto text-lg leading-relaxed">
                            Shrink your images securely in the browser. <br/>
                            No server uploads. No file limits.
                        </p>
                    </div>

                    {/* --- Main Grid --- */}
                    <div className="w-full max-w-7xl grid grid-cols-1 lg:grid-cols-12 gap-8">
                        
                        {/* --- LEFT COLUMN: Controls --- */}
                        <div className="lg:col-span-4 space-y-6">
                            
                            {/* Settings Panel */}
                            <div className="glass-panel rounded-2xl p-6 shadow-2xl animate-card" style={{animationDelay: '0.1s'}}>
                                <div className="flex items-center gap-2 mb-6 text-white font-semibold text-lg border-b border-white/10 pb-4">
                                    <IconSettings /> Global Settings
                                </div>

                                <div className="space-y-6">
                                    {/* Format Selection */}
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Output Format</label>
                                        <div className="grid grid-cols-3 gap-2">
                                            {['image/jpeg', 'image/png', 'image/webp'].map(fmt => (
                                                <button 
                                                    key={fmt}
                                                    onClick={() => setGlobalSettings(s => ({...s, format: fmt}))}
                                                    className={`text-sm py-2.5 rounded-xl font-medium transition-all duration-200 border ${
                                                        globalSettings.format === fmt 
                                                        ? 'bg-indigo-600 border-indigo-500 text-white shadow-lg shadow-indigo-500/20' 
                                                        : 'bg-slate-800/50 border-transparent text-slate-400 hover:bg-slate-700 hover:text-white'
                                                    }`}
                                                >
                                                    {fmt.split('/')[1].toUpperCase()}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Quality Slider */}
                                    <div>
                                        <div className="flex justify-between mb-2">
                                            <label className="text-xs font-semibold text-slate-400 uppercase tracking-wider">Quality</label>
                                            <span className="text-xs bg-indigo-500/20 text-indigo-300 px-2 py-0.5 rounded font-mono font-bold">
                                                {Math.round(globalSettings.quality * 100)}%
                                            </span>
                                        </div>
                                        <input 
                                            type="range" 
                                            min="0.1" 
                                            max="1" 
                                            step="0.05" 
                                            value={globalSettings.quality}
                                            onChange={(e) => setGlobalSettings(s => ({...s, quality: parseFloat(e.target.value)}))}
                                            className="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-500 hover:accent-indigo-400 transition-all"
                                        />
                                        <div className="flex justify-between text-[10px] text-slate-500 mt-1">
                                            <span>Low</span>
                                            <span>Lossless-ish</span>
                                        </div>
                                    </div>

                                    {/* Max Width */}
                                    <div>
                                        <div className="flex justify-between mb-2">
                                            <label className="text-xs font-semibold text-slate-400 uppercase tracking-wider">Resize Width</label>
                                            <span className="text-xs bg-indigo-500/20 text-indigo-300 px-2 py-0.5 rounded font-mono font-bold">
                                                {globalSettings.maxWidth}px
                                            </span>
                                        </div>
                                        <input 
                                            type="range" 
                                            min="400" 
                                            max="3840" 
                                            step="100" 
                                            value={globalSettings.maxWidth}
                                            onChange={(e) => setGlobalSettings(s => ({...s, maxWidth: parseInt(e.target.value)}))}
                                            className="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-500 hover:accent-indigo-400 transition-all"
                                        />
                                    </div>
                                </div>
                            </div>

                            {/* Stats & Download Panel */}
                            {files.length > 0 && (
                                <div className="glass-panel rounded-2xl p-6 shadow-2xl animate-card" style={{animationDelay: '0.2s'}}>
                                    <div className="grid grid-cols-2 gap-4 mb-5">
                                        <div className="bg-slate-800/50 rounded-xl p-3 border border-white/5">
                                            <p className="text-[10px] text-slate-500 uppercase tracking-wider mb-1">Original Size</p>
                                            <p className="text-lg font-mono text-slate-300">{formatBytes(totalOriginal)}</p>
                                        </div>
                                        <div className="bg-indigo-500/10 rounded-xl p-3 border border-indigo-500/20">
                                            <p className="text-[10px] text-indigo-300/70 uppercase tracking-wider mb-1">Optimized Size</p>
                                            <p className="text-lg font-mono text-indigo-300">{formatBytes(totalCompressed)}</p>
                                        </div>
                                    </div>

                                    <div className="bg-slate-800/50 rounded-full h-3 w-full overflow-hidden relative mb-2">
                                        <div 
                                            className="absolute top-0 left-0 h-full bg-gradient-to-r from-emerald-500 to-teal-400 transition-all duration-700 ease-out"
                                            style={{ width: `${100 - totalSavings}%` }}
                                        ></div>
                                    </div>
                                    <div className="flex justify-center items-center gap-2 mb-6">
                                        <span className="text-emerald-400 text-sm font-bold">Saved {totalSavings}%</span>
                                        <span className="text-slate-600 text-xs">•</span>
                                        <span className="text-slate-400 text-xs">{(totalOriginal - totalCompressed) > 0 ? formatBytes(totalOriginal - totalCompressed) : 0} reduced</span>
                                    </div>

                                    <button 
                                        onClick={downloadAll}
                                        className="w-full py-3.5 rounded-xl bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white font-bold shadow-lg shadow-indigo-600/25 transition-all active:scale-[0.98] flex items-center justify-center gap-2"
                                    >
                                        <IconDownload /> Download All
                                    </button>
                                </div>
                            )}
                        </div>

                        {/* --- RIGHT COLUMN: Dropzone & List --- */}
                        <div className="lg:col-span-8 flex flex-col h-[650px]">
                            
                            {/* Drop Zone */}
                            <div 
                                onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}
                                onDragLeave={() => setIsDragging(false)}
                                onDrop={handleDrop}
                                className={`relative group flex-shrink-0 mb-6 rounded-2xl transition-all duration-300 ease-out cursor-pointer overflow-hidden
                                    ${isDragging 
                                        ? 'bg-indigo-500/20 border-2 border-indigo-400 scale-[1.01] shadow-[0_0_30px_rgba(99,102,241,0.2)]' 
                                        : 'glass-panel border-2 border-dashed border-slate-700 hover:border-indigo-500/50 hover:bg-slate-800/80'
                                    }`}
                                style={{ minHeight: files.length === 0 ? '300px' : '160px' }}
                            >
                                <input 
                                    type="file" 
                                    multiple 
                                    accept="image/*"
                                    onChange={handleFileSelect}
                                    className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                />
                                <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                    <div className={`p-4 rounded-full mb-4 transition-transform duration-300 ${isDragging ? 'bg-indigo-500 text-white scale-110' : 'bg-slate-800 text-indigo-400 group-hover:scale-110 group-hover:bg-slate-700'}`}>
                                        <IconUpload />
                                    </div>
                                    <h3 className="text-xl font-semibold text-white mb-1">
                                        {isDragging ? 'Drop it like it\'s hot!' : 'Drag & Drop Images'}
                                    </h3>
                                    <p className="text-slate-400 text-sm">or click to browse your files</p>
                                </div>
                            </div>

                            {/* File List */}
                            <div className="flex-1 overflow-y-auto custom-scrollbar glass-panel rounded-2xl p-6 border border-white/5">
                                {files.length === 0 ? (
                                    <div className="h-full flex flex-col items-center justify-center text-slate-600">
                                        <IconImage />
                                        <p className="mt-4 text-sm font-medium">Your optimized images will appear here</p>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-4">
                                        {files.map((file, idx) => (
                                            <div 
                                                key={file.id} 
                                                className="bg-slate-800/40 hover:bg-slate-800/80 rounded-xl p-3 flex gap-4 items-center border border-white/5 transition-colors group relative animate-card"
                                                style={{ animationDelay: `${idx * 0.05}s` }}
                                            >
                                                
                                                {/* Thumbnail */}
                                                <div className="w-20 h-20 flex-shrink-0 bg-slate-900 rounded-lg overflow-hidden border border-white/5 relative group-hover:border-white/10 transition-colors">
                                                    {file.status === 'processing' ? (
                                                        <div className="w-full h-full flex items-center justify-center text-indigo-400"><IconLoader /></div>
                                                    ) : (
                                                        <div className="w-full h-full relative">
                                                            <img src={file.previewUrl} alt="preview" className="w-full h-full object-cover" />
                                                            <div className="absolute inset-0 bg-black/20"></div>
                                                        </div>
                                                    )}
                                                </div>

                                                {/* Details */}
                                                <div className="flex-1 min-w-0 py-1">
                                                    <div className="flex justify-between items-start">
                                                        <p className="text-sm font-medium text-slate-200 truncate pr-8" title={file.original.name}>{file.original.name}</p>
                                                    </div>
                                                    
                                                    {file.status === 'done' && (
                                                        <div className="mt-2">
                                                            <div className="flex items-center gap-2 text-xs mb-1.5">
                                                                <span className="text-slate-500 line-through">{formatBytes(file.originalSize)}</span>
                                                                <svg className="w-3 h-3 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
                                                                <span className="text-emerald-400 font-bold bg-emerald-500/10 px-1.5 rounded">{formatBytes(file.compressedSize)}</span>
                                                            </div>
                                                            <div className="text-[10px] text-slate-500 font-mono">
                                                                {file.width} × {file.height}px
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>

                                                {/* Actions */}
                                                <button 
                                                    onClick={() => removeFile(file.id)}
                                                    className="absolute top-3 right-3 p-1.5 text-slate-600 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-colors opacity-0 group-hover:opacity-100"
                                                    title="Remove"
                                                >
                                                    <IconTrash />
                                                </button>

                                                {/* Status Icon */}
                                                {file.status === 'done' && (
                                                    <div className="absolute bottom-3 right-3 text-emerald-500 bg-emerald-500/10 p-1 rounded-full border border-emerald-500/20">
                                                        <IconCheck />
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                    
                    {/* Footer */}
                    <div className="mt-12 text-slate-600 text-sm">
                        <p>Privacy First. No images are uploaded.</p>
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
